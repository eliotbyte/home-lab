services:
  db:
    image: postgres:${POSTGRES_VERSION:-14}
    restart: always
    environment:
      - POSTGRES_USER=${GITEA_DB_USER}
      - POSTGRES_PASSWORD=${GITEA_DB_PASSWORD}
      - POSTGRES_DB=${GITEA_DB_NAME}
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    networks:
      - gitea-net

  gitea:
    image: gitea/gitea:latest
    restart: always
    depends_on:
      - db
    environment:
      - USER_UID=${GITEA_UID:-110}
      - USER_GID=${GITEA_GID:-111}
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=db:5432
      - GITEA__database__NAME=${GITEA_DB_NAME}
      - GITEA__database__USER=${GITEA_DB_USER}
      - GITEA__database__PASSWD=${GITEA_DB_PASSWORD}
    volumes:
      - ./gitea_data:/data
    networks:
      - gitea-net
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      - "traefik.http.routers.${SERVICE_NAME}.rule=Host(`${HOST_NAME}`)"
      - "traefik.http.routers.${SERVICE_NAME}.entrypoints=http"
      - "traefik.http.services.${SERVICE_NAME}.loadbalancer.server.port=${GITEA_PORT:-3000}"
      - "traefik.constraint=proxy-public"
      - "traefik.http.middlewares.gitea-strip.stripprefix.prefixes=/"
      - "traefik.http.routers.${SERVICE_NAME}.middlewares=gitea-strip"

networks:
  traefik:
    name: homelab_traefik
    external: true
  gitea-net:
    driver: bridge